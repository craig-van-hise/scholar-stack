
# Product Requirements Prompt (PRP): Iterative Vertical Search

**Role:** Senior Search Architect
**Task:** Replace the existing "Backdoor" and "Direct Expansion" search methods with a high-recall **Iterative Loop Strategy**.

## 1. Core Logic: "Divide and Conquer"

Instead of sending one massive, complex query to OpenAlex (which causes the API to drop results), the script must execute **8 separate, high-precision searches**.

* **Hypothesis:** `("binaural") AND ("crosstalk cancellation")` yields 100 papers. `("ambisonics") AND ("crosstalk cancellation")` yields 6 papers. Combining them into one query confuses the indexer. Keeping them separate maximizes yield.

## 2. Phase 1: Vertical Identification (LLM)

* **Action:** Query the LLM to identify the **8 High-Yield Search Verticals** for the user's topic.
* **Prompt Requirement:** Explicitly ask for a mix of **Horizontal Synonyms** (e.g., "3D Audio", "Immersive Sound") and **Vertical Sub-disciplines** (e.g., "Binaural", "Ambisonics").
* **Goal:** These 8 terms act as the "Domain Anchors" for the subsequent loops.

## 3. Phase 2: The Execution Loop

* **Action:** Iterate through the list of 8 verticals.
* **Query Construction:** For each vertical, construct a simple, powerful query: `("{Original_Keyword}") AND ("{Vertical_Term}")`.
* **Execution:** Run the standard `execute_openalex_query` for each loop.
* **Deduplication:** The script must handle duplicates automatically (checking `openalex_id` before adding to the catalog) since some papers will appear in multiple verticals.

## 4. Phase 3: The Validation Gate (Unchanged)

* **Action:** Every candidate found in *any* loop is immediately sent to the **Section-Aware PDF Auditor**.
* **Logic:** Download the PDF -> Extract Page 1 & 2 (Text Only) -> Run Fuzzy Regex for the *Original Keyword*.
* **Result:** This ensures that even if a vertical is broad ("3D Audio"), we only keep papers that specifically mention "Crosstalk Cancellation" in the front matter.

---

### Implementation Code Block

Copy and paste this code into your `ResearchCrawler` class to replace the previous search method.

```python
    def search_via_iterative_loop(self):
        """
        STRATEGY: Divide and Conquer.
        Runs separate, targeted searches for distinct sub-fields to maximize recall 
        and bypass OpenAlex query complexity limits.
        """
        clean_keyword = self.keywords_list[0].replace('"', '')
        print(f"\nğŸš€ STARTING ITERATIVE LOOP SEARCH for: '{self.raw_topic}' + '{clean_keyword}'")
        
        # --- STEP 1: GENERATE SEARCH VERTICALS ---
        print("   ğŸ§  Defining Search Verticals with LLM...")
        prompt = (
            f"The user is researching '{self.raw_topic}'. Identify the 8 most distinct, high-yield 'Search Verticals' "
            f"for finding papers in this field. \n"
            f"INSTRUCTIONS:\n"
            f"1. Include Broad Synonyms (e.g., if topic is Spatial Audio -> '3D Audio', 'Immersive Audio')\n"
            f"2. Include Core Sub-disciplines (e.g., 'Binaural', 'Ambisonics', 'Wave Field Synthesis')\n"
            f"3. Return ONLY a comma-separated list of 8 terms."
        )
        
        # Get verticals and ensure the original topic is included
        raw_response = self.llm_query(prompt)
        verticals = [s.strip().replace('"', '') for s in raw_response.split(',') if len(s.strip()) > 3]
        
        # Ensure the user's raw topic is always the first loop
        if self.raw_topic not in verticals:
            verticals.insert(0, self.raw_topic)
            
        print(f"   âœ… Targeted Verticals: {verticals}")

        # --- STEP 2: EXECUTE LOOP ---
        total_found = 0
        
        for vertical in verticals:
            print(f"\n   ğŸ”„ Loop: ('{clean_keyword}') AND ('{vertical}')")
            
            # Construct simple, high-power query
            query = f'("{clean_keyword}") AND ("{vertical}")'
            
            # Execute standard query 
            # Note: The execute_openalex_query method handles PDF downloading and Deduplication internally.
            filters = "is_oa:true,type:article|conference-paper"
            if self.date_start: filters += f",publication_year:>{self.year_start-1}"
            
            self.execute_openalex_query(f"Vertical: {vertical}", filters, query)
            
        print(f"\n   ğŸ Iterative Loop Complete. Final Catalog Size: {len(self.research_catalog)}")

```