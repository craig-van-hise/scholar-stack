
# PRP: ScholarStack Phase 3 - Taxonomy Logic Fixes

**Context:**
We are upgrading the `cluster_and_categorize` pipeline in ScholarStack. The current recursive clustering logic is working architecturally (sampling -> broad categories -> sub-clustering), but we have two critical data-integrity bugs causing file system errors and poor user experience.

**Objective:**
Update the prompt engineering within the python script to strictly enforce file-system safety and reduce folder clutter (atomization).

### üêõ Current Issues

1. **Directory Injection via Slashes (Critical):**
* **Behavior:** In Phase 1, the LLM outputs categories like `"Immersive Environments (VR/AR)"`.
* **Impact:** The system interprets `/` as a directory separator, creating nested folders (`Immersive Environments (VR` -> `AR)`) causing papers to be hidden in incorrect sub-directories.
* **Fix:** We must strictly forbid forward slashes in the Phase 1 prompt.


2. **Over-Atomization (UX):**
* **Behavior:** In Phase 3, the "Specialist" agent creates a unique folder for almost every paper (e.g., 79 papers resulting in 51 sub-folders).
* **Impact:** The user is overwhelmed by single-paper folders.
* **Fix:** We must adjust the Phase 3 prompt to force "Clustering" (grouping into 4-6 themes) rather than "Labeling" (describing each paper uniquely).



---

### üõ†Ô∏è Implementation Requirements

Please modify the `cluster_and_categorize.py` script with the following changes:

#### 1. Update `generate_root_taxonomy` Prompt

Modify the prompt sent to the model to include a "Forbidden Characters" rule.

* **New Rule:** "Use `&` or `and` instead of `/`. Forward slashes are strictly forbidden."
* **Constraint:** Ensure the model understands this is for a file system.

#### 2. Update `cluster_subfolder` Prompt

Modify the prompt to force density over specificity.

* **Instruction Change:** Change "Assign every paper to a sub-category" to "Identify 4-6 core themes."
* **New Rule:** "Do not create categories for single papers. Generalize themes to ensure groups contain multiple papers."
* **Fallback:** explicit instruction to use `"General {Parent_Name}"` for outliers rather than making a new folder.

---

### üìù Reference Code Snippets (Desired Logic)

**For Phase 1 (The Architect):**

```python
    Rules:
    1. Categories must be **BROAD** (e.g., "Signal Processing", "Machine Learning").
    2. **FORBIDDEN:** Do NOT use forward slashes (/) in names. Use "and" or "&" instead (e.g., "VR and AR", not "VR/AR").
    3. Do NOT create granular technical folders yet.
    4. Return ONLY the list of category names.

```

**For Phase 3 (The Specialist):**

```python
    Task:
    1. Analyze these papers and identify **4 to 6 core themes**.
    2. Group papers into these themes. **Do NOT create single-paper categories.**
    3. Generalize the names (e.g., use "Ambisonic Comparison" instead of "Ambisonics vs Object-Based...").
    4. If a paper doesn't fit a specific theme, assign it to "General {parent_category}".

```

### ‚úÖ Verification Steps

1. Run the script.
2. Verify no folders contain `/` or are split unexpectedly.
3. Verify that large topics (like "Signal Processing") result in < 10 sub-folders, not 50.